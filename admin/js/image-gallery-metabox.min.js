(function($){var media_frame;$(document).on('click.igmbpAddMediaManager','#image-gallery-meta-box a.gallery-add',function(e){e.preventDefault();if(media_frame){media_frame.close();}media_frame=wp.media.frames.media_frame=wp.media({className:'media-frame igmb-add-media-frame',frame:'select',multiple:true,title:image_gallery_metabox.add_title,library:{type:'image'},button:{text:image_gallery_metabox.add_button}});media_frame.on('select',function(){var listIndex=$('#gallery-metabox-list li').index($('#gallery-metabox-list li:last')),selection=media_frame.state().get('selection');selection.map(function(attachment,i){attachment=attachment.toJSON(),index=listIndex+(i+1);if(attachment.sizes.thumbnail){attachmentSource=attachment.sizes.thumbnail.url;}else{attachmentSource=attachment.url;}$('#gallery-metabox-list').append('<li><input type="hidden" name="_igmb_image_gallery_id['+index+']" value="'+attachment.id+'"><img class="image-preview" src="'+attachmentSource+'"><a class="edit-image" href="#" title="'+image_gallery_metabox.link_edit_title+'"></a><a class="remove-image" href="#" title="'+image_gallery_metabox.link_remove_title+'"></a></li>');});});makeSortable();media_frame.open();});$(document).on('click.igmbEditMediaManager','#image-gallery-meta-box a.edit-image',function(e){e.preventDefault();var that=$(this);if(media_frame){media_frame.close();}media_frame=wp.media.frames.media_frame=wp.media({className:'media-frame igmb-edit-media-frame',frame:'select',multiple:false,title:image_gallery_metabox.edit_title,library:{type:'image'},button:{text:image_gallery_metabox.edit_button}});media_frame.on('open',function(){var selection=media_frame.state().get('selection');id=that.parent().find('input:hidden').val();attachment=wp.media.attachment(id);attachment.fetch();selection.add(attachment?[attachment]:[]);});media_frame.on('select',function(){attachment=media_frame.state().get('selection').first().toJSON();if(attachment.sizes.thumbnail){attachmentSource=attachment.sizes.thumbnail.url;}else{attachmentSource=attachment.url;}that.parent().find('input:hidden').attr('value',attachment.id);that.parent().find('img.image-preview').attr('src',attachmentSource);});media_frame.open();});function resetIndex(){$('#gallery-metabox-list li').each(function(i){$(this).find('input:hidden').attr('name','_igmb_image_gallery_id['+i+']');});}function makeSortable(){$('#gallery-metabox-list').sortable({opacity:0.8,stop:function(){resetIndex();}});}$(document).on('click.igmbRemoveMedia','#image-gallery-meta-box a.remove-image',function(e){e.preventDefault();$(this).parents('li').animate({opacity:0},200,function(){$(this).remove();resetIndex();});});$(document).ready(function(){makeSortable();});})(jQuery);